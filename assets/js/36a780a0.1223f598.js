"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2755],{9583:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>l});var n=t(4848),i=t(8453);const r={},o=void 0,s={id:"cpp/coroutines/co_await",title:"co_await",description:"\u5728co_await \u8868\u8fbe\u5f0f\u4e2d\u83b7\u53d6awaiter\u5bf9\u8c61\u7684\u65b9\u6cd5",source:"@site/docs/cpp/coroutines/co_await.md",sourceDirName:"cpp/coroutines",slug:"/cpp/coroutines/co_await",permalink:"/docs/cpp/coroutines/co_await",draft:!1,unlisted:!1,editUrl:"https://github.com/1036-ce/1036-ce.github.io/blob/main/docs/cpp/coroutines/co_await.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"constexpr",permalink:"/docs/cpp/constexpr"},next:{title:"\u6df1\u5165\u7406\u89e3co_await",permalink:"/docs/cpp/coroutines/co_await_trans"}},c={},l=[{value:"\u5728<code>co_await &lt;expr&gt;</code>\u8868\u8fbe\u5f0f\u4e2d\u83b7\u53d6<code>awaiter</code>\u5bf9\u8c61\u7684\u65b9\u6cd5",id:"\u5728co_await-expr\u8868\u8fbe\u5f0f\u4e2d\u83b7\u53d6awaiter\u5bf9\u8c61\u7684\u65b9\u6cd5",level:2},{value:"\u5bf9\u4e8e\u6709\u8fd4\u56de\u7c7b\u578b\u4e3avoid\u6216bool\u7684await_suspend()\u65b9\u6cd5\u7684co_await\u6267\u884c\u6d41\u7a0b",id:"\u5bf9\u4e8e\u6709\u8fd4\u56de\u7c7b\u578b\u4e3avoid\u6216bool\u7684await_suspend\u65b9\u6cd5\u7684co_await\u6267\u884c\u6d41\u7a0b",level:2},{value:"\u5bf9\u4e8e\u4f7f\u7528\u5bf9\u79f0\u4f20\u8f93\u7684await_suspend()\u65b9\u6cd5\u7684co_await\u6267\u884c\u6d41\u7a0b:",id:"\u5bf9\u4e8e\u4f7f\u7528\u5bf9\u79f0\u4f20\u8f93\u7684await_suspend\u65b9\u6cd5\u7684co_await\u6267\u884c\u6d41\u7a0b",level:2}];function p(e){const a={code:"code",h2:"h2",pre:"pre",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(a.h2,{id:"\u5728co_await-expr\u8868\u8fbe\u5f0f\u4e2d\u83b7\u53d6awaiter\u5bf9\u8c61\u7684\u65b9\u6cd5",children:["\u5728",(0,n.jsx)(a.code,{children:"co_await <expr>"}),"\u8868\u8fbe\u5f0f\u4e2d\u83b7\u53d6",(0,n.jsx)(a.code,{children:"awaiter"}),"\u5bf9\u8c61\u7684\u65b9\u6cd5"]}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-cpp",children:"template <typename P, typename T>\ndecltype(auto) get_awaitable(P& promise, T&& expr) {\n    if constexpr(has_any_await_transform_member_v<P>)\n        return promise.await_transform(static_cast<T&&>(expr));\n    else\n        return static_cast<T&&>(expr);\n}\n\ntemplate <typenamt Awaitable>\ndecltype(auto) get_awaiter(Awaitable&& awaitable) {\n    if constexpr(has_member_operator_co_await_v(Awaitable))\n        return static_cast<Awaitable&&>(awaitable).operator coawait();\n    else if constexpr (has_non_member_operator_co_await_v<Awaitable&&>)\n        return operator co_await(static_cast<Awaitable&&>(awaitbale);\n    else\n        return static_cast<Awaitable&&>(awaitable);\n}\n"})}),"\n",(0,n.jsx)(a.h2,{id:"\u5bf9\u4e8e\u6709\u8fd4\u56de\u7c7b\u578b\u4e3avoid\u6216bool\u7684await_suspend\u65b9\u6cd5\u7684co_await\u6267\u884c\u6d41\u7a0b",children:"\u5bf9\u4e8e\u6709\u8fd4\u56de\u7c7b\u578b\u4e3avoid\u6216bool\u7684await_suspend()\u65b9\u6cd5\u7684co_await\u6267\u884c\u6d41\u7a0b"}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-cpp",children:"{\n    auto&& value = <expr>;\n    auto&& awaitable = get_awaitable(promise, static_cast<decltype(value)>(value));\n    auto&& awaiter = get_awaiter(static_cast<decltype(awaitable)>(awaitable));\n    if (!awaiter.awaitr_ready) {\n        using handle_t = std::coroutine_handle<P>;\n        using await_suspend_result_t =\n                decltype(awaiter.await_suspend(handlt_t::fromt_promise(p)));\n\n        <suspend-point>;\n\n        // \u4ee5\u4e0b\u4ee3\u7801\u5728\u6302\u8d77\u4e4b\u540e\u7acb\u5373\u6267\u884c\n        if constexpr(std::is_void_v<await_suspend_result_t>) {\n            awaiter.await_suspend(handle_t::from_promise(p));\n            <return-to-caller-or-resumer>;\n        }\n        else {\n            static_assert(\n                    std::is_same_v<await_suspend_result_t, bool>,\n                    \"await_suspend() must return 'void' or 'bool'.\");\n\n            if (awaiter.await_suspend(handle_t::from_promise(p)))\n                <return-to-caller-or-resumer>\n        }\n\n        <resume-point>;\n    }\n\n    return awaiter.await_resume();\n}\n"})}),"\n",(0,n.jsx)(a.h2,{id:"\u5bf9\u4e8e\u4f7f\u7528\u5bf9\u79f0\u4f20\u8f93\u7684await_suspend\u65b9\u6cd5\u7684co_await\u6267\u884c\u6d41\u7a0b",children:"\u5bf9\u4e8e\u4f7f\u7528\u5bf9\u79f0\u4f20\u8f93\u7684await_suspend()\u65b9\u6cd5\u7684co_await\u6267\u884c\u6d41\u7a0b:"}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-cpp",children:"{\n    decltype(auto) value = <expr>;\n    decltype(auto) awaitable = \n        get_awaitable(promise, static_cast<decltype(value)&&>(value));\n    decltype(auto) awaiter = \n        get_awaiter(static_cast<decltype(awaitable>&&)(awaitable));\n\n    if (!awaiter.await_ready()) {\n        using handle_t = std::coroutine_handle<P>;\n\n        // <suspend-coroutine>\n\n        // \u4ee5\u4e0b\u4ee3\u7801\u5728\u6302\u8d77\u4e4b\u540e\u7acb\u5373\u6267\u884c\n        auto h = awaiter.await_suspend(handle_t::from_promise(p));\n        h.resume();\n        // <return-to-caller-or-resumer>\n\n        // <resume-point>\n    }\n\n    return awaiter.await_resume();\n}\n"})})]})}function u(e={}){const{wrapper:a}={...(0,i.R)(),...e.components};return a?(0,n.jsx)(a,{...e,children:(0,n.jsx)(p,{...e})}):p(e)}},8453:(e,a,t)=>{t.d(a,{R:()=>o,x:()=>s});var n=t(6540);const i={},r=n.createContext(i);function o(e){const a=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function s(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(r.Provider,{value:a},e.children)}}}]);