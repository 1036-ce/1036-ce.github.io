"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2519],{8565:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>r,toc:()=>l});var s=t(4848),i=t(8453);const d={},c=void 0,r={id:"linux/shm",title:"shm",description:"shared memory",source:"@site/docs/linux/shm.md",sourceDirName:"linux",slug:"/linux/shm",permalink:"/docs/linux/shm",draft:!1,unlisted:!1,editUrl:"https://github.com/1036-ce/1036-ce.github.io/blob/main/docs/linux/shm.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"little",permalink:"/docs/linux/little"},next:{title:"make",permalink:"/docs/make"}},o={},l=[{value:"shared memory",id:"shared-memory",level:2},{value:"POSIX \u5171\u4eab\u5185\u5b58",id:"posix-\u5171\u4eab\u5185\u5b58",level:3},{value:"System V \u5171\u4eab\u5185\u5b58",id:"system-v-\u5171\u4eab\u5185\u5b58",level:3}];function m(n){const e={code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,i.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h2,{id:"shared-memory",children:"shared memory"}),"\n",(0,s.jsx)(e.h3,{id:"posix-\u5171\u4eab\u5185\u5b58",children:"POSIX \u5171\u4eab\u5185\u5b58"}),"\n",(0,s.jsx)(e.p,{children:"\u5e38\u7528\u51fd\u6570\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:"#include <sys/mman.h>\n#include <sys/stat.h>   /* For mode constatns */\n#include <fcntl.h>      /* For O_* constatns */\n#include <unistd.h>     /* For ftruncate */\n\nint shm_open(const char* name, int oflag, mode_t mode);\nint shm_unlink(const char *name);\nint ftruncate(int fd, off_t length);\nvoid *mmap(void addr, size_t length, int prot, int flags, int fd, off_t offset);\nint munmap(void addr, size_t length);\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u4f7f\u7528\u793a\u4f8b"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:'#include <sys/mman.h>\n#include <sys/stat.h>   /* For mode constatns */\n#include <fcntl.h>      /* For O_* constatns */\n#include <unistd.h>     /* For ftruncate */\n#include <stdio.h>\n#include <stdlib.h>\n\nint main() {\n  const char *name = "shm";\n  int size = 4096;\n\n  int fd = shm_open(name, O_CREAT | O_RDWR, 0666);\n  if (fd == -1) {\n    perror("shm_open");\n    exit(1);\n  }\n\n  // \u8bbe\u7f6e\u5171\u4eab\u5185\u5b58\u5927\u5c0f\n  ftruncate(fd, size);\n\n  char *ptr = (char*)mmap(NULL, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);\n  if (ptr == MAP_FAILED) {\n    perror("mmap");\n    exit(1);\n  }\n\n  /* Your code */\n\n  munmap(ptr, size);\n  close(fd);\n  shm_unlink(name);\n}\n'})}),"\n",(0,s.jsxs)(e.p,{children:["\u4f7f\u7528POSIX\u521b\u5efa\u7684\u5171\u4eab\u5185\u5b58\u4ee5\u6587\u4ef6\u5f62\u5f0f\u5b58\u5728\u4e0e",(0,s.jsx)(e.code,{children:"/dev/shm"}),"\u4e2d"]}),"\n",(0,s.jsxs)(e.p,{children:["\u56e0\u6b64\u4e5f\u66f4\u5bb9\u6613\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u7684",(0,s.jsx)(e.code,{children:"select"}),", ",(0,s.jsx)(e.code,{children:"epool"}),"\u673a\u5236\u7ed3\u5408"]}),"\n",(0,s.jsx)(e.p,{children:"\u4e00\u822c\u63a8\u8350\u4f7f\u7528POSIX\u5171\u4eab\u5185\u5b58"}),"\n",(0,s.jsx)(e.h3,{id:"system-v-\u5171\u4eab\u5185\u5b58",children:"System V \u5171\u4eab\u5185\u5b58"}),"\n",(0,s.jsx)(e.p,{children:"\u5e38\u7528\u51fd\u6570\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:"#include <sys/shm.h>\n\nint shmget(key_t key, size_t size, int shmflg);\nvoid* shmat(int shmid, const void* shmaddr, int shmflg);\nint shmdt(const void* shmaddr);\nint shmctl(int shmid, int op, struct shmid_ds *buf);\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u4f7f\u7528\u793a\u4f8b"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:"#include <sys/shm.h>\n\nint main() {\n  // \u521b\u5efa\n  int shmid = shmget(1234, SIZE, IPC_CREAT | 0666);\n  void *ptr = shmat(shmid, NULL, 0);\n  // \u4f7f\u7528 ptr \u901a\u4fe1\n  // \u6e05\u7406\n  shmdt(ptr);\n  shmctl(shmid, IPC_RMID, NULL);\n}\n"})})]})}function h(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(m,{...n})}):m(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>c,x:()=>r});var s=t(6540);const i={},d=s.createContext(i);function c(n){const e=s.useContext(d);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:c(n.components),s.createElement(d.Provider,{value:e},n.children)}}}]);